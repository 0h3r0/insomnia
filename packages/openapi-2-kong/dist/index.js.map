{"version":3,"sources":["common.js","security-plugins.js","plugins.js","services.js","upstreams.js","index.js"],"names":["parseSpec","spec","api","JSON","parse","err","SwaggerParser","YAML","stringify","info","openapi","dereference","getServers","obj","servers","getAllServers","p","Object","keys","paths","server","push","getSecurity","security","getName","name","generateSlug","title","str","replace","pathVariablesToRegex","parseUrl","urlStr","parsed","url","port","protocol","host","hostname","joinPath","p1","p2","generateSecurityPlugins","op","plugins","securitySchemes","components","securityItem","scheme","generateSecurityPlugin","generateApiKeySecurityPlugin","includes","in","Error","type","config","key_names","generateHttpSecurityPlugin","generateOpenIdConnectSecurityPlugin","args","openIdConnectUrl","issuer","scopes_required","generateOAuth2SecurityPlugin","auth_methods","plugin","key","indexOf","kongSecurity","generatePlugins","operation","generatePlugin","match","generateRequestValidatorPlugin","version","parameters","schema","parameter_schema","explode","required","style","requestBody","content","bodySchema","item","mediatype","body_schema","enabled","generateServices","tags","length","generateService","pathname","service","path","parseInt","routes","routePath","pathItem","method","fullPath","fullPathRegex","route","generateRouteName","methods","toUpperCase","strip_path","securityPlugins","numRoutes","n","summary","generateUpstreams","upstream","targets","target","generate","specPath","Promise","resolve","reject","readFile","contents","fileSlug","allTags","basename","generateFromString","specStr","generateFromSpec","_format_version","services","upstreams","message"],"mappings":"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","file":"index.js","sourceRoot":"../src","sourcesContent":["// @flow\nimport SwaggerParser from 'swagger-parser';\nimport url from 'url';\n\nexport async function parseSpec(spec: string | Object): Promise<OpenApi3Spec> {\n  let api: OpenApi3Spec;\n\n  if (typeof spec === 'string') {\n    try {\n      api = JSON.parse(spec);\n    } catch (err) {\n      api = SwaggerParser.YAML.parse(spec);\n    }\n  } else {\n    api = JSON.parse(JSON.stringify(spec));\n  }\n\n  // Ensure it has some required properties to make parsing\n  // a bit less strict\n\n  if (!api.info) {\n    api.info = {};\n  }\n\n  if (api.openapi === '3.0') {\n    api.openapi = '3.0.0';\n  }\n\n  return SwaggerParser.dereference(api);\n}\n\nexport function getServers(obj: OpenApi3Spec | OA3PathItem): Array<OA3Server> {\n  return obj.servers || [];\n}\n\nexport function getAllServers(api: OpenApi3Spec): Array<OA3Server> {\n  const servers = getServers(api);\n\n  for (const p of Object.keys(api.paths)) {\n    for (const server of getServers(api.paths[p])) {\n      servers.push(server);\n    }\n  }\n\n  return servers;\n}\n\nexport function getSecurity(\n  obj: OpenApi3Spec | OA3Operation,\n): Array<OA3SecurityRequirement> | null {\n  return obj.security || [];\n}\n\nexport function getName(obj: OpenApi3Spec | OA3Operation): string {\n  let name;\n\n  if ((obj: any)['x-kong-name']) {\n    name = (obj: any)['x-kong-name'];\n  }\n\n  if (!name && obj.info && obj.info.title) {\n    name = obj.info.title;\n  }\n\n  return generateSlug(name || 'openapi');\n}\n\nexport function generateSlug(str: string): string {\n  return str.replace(/[\\s_\\-.~,]/g, '_');\n}\n\nexport function pathVariablesToRegex(p: string): string {\n  return p.replace(/{([^}]+)}/g, '(?<$1>\\\\S+)') + '$';\n}\n\nexport function parseUrl(\n  urlStr: string,\n): {|\n  host: string,\n  port: string,\n  protocol: string,\n  pathname: string,\n|} {\n  const parsed: Object = url.parse(urlStr);\n\n  if (!parsed.port && parsed.protocol === 'https:') {\n    parsed.port = '443';\n  } else if (!parsed.port && parsed.protocol === 'http:') {\n    parsed.port = '80';\n  }\n\n  parsed.protocol = parsed.protocol || 'http:';\n  parsed.host = `${parsed.hostname}:${parsed.port}`;\n\n  return parsed;\n}\n\nexport function joinPath(p1: string, p2: string): string {\n  p1 = p1.replace(/\\/$/, '');\n  p2 = p2.replace(/^\\//, '');\n\n  return `${p1}/${p2}`;\n}\n","// @flow\n\nimport { getSecurity } from './common';\n\nexport function generateSecurityPlugins(op: OA3Operation, api: OpenApi3Spec): Array<DCPlugin> {\n  const plugins = [];\n  const components = api.components || {};\n  const securitySchemes = components.securitySchemes || {};\n\n  const security = getSecurity(op) || getSecurity(api) || [];\n  for (const securityItem of security) {\n    for (const name of Object.keys(securityItem)) {\n      const scheme: OA3SecurityScheme = securitySchemes[name] || {};\n      const args = securityItem[name];\n\n      const p = generateSecurityPlugin(scheme, args);\n\n      if (p) {\n        plugins.push(p);\n      }\n    }\n  }\n\n  return plugins;\n}\n\nexport function generateApiKeySecurityPlugin(scheme: OA3SecuritySchemeApiKey): DCPlugin {\n  if (!['query', 'header', 'cookie'].includes(scheme.in)) {\n    throw new Error(`a ${scheme.type} object expects valid \"in\" property. Got ${scheme.in}`);\n  }\n  if (!scheme.name) {\n    throw new Error(`a ${scheme.type} object expects valid \"name\" property. Got ${scheme.name}`);\n  }\n\n  return {\n    name: 'key-auth',\n    config: { key_names: [scheme.name] },\n  };\n}\n\nexport function generateHttpSecurityPlugin(scheme: OA3SecuritySchemeHttp): DCPlugin {\n  if (scheme.scheme !== 'basic') {\n    throw new Error(`Only \"basic\" http scheme supported. got ${scheme.scheme}`);\n  }\n\n  return {\n    name: 'basic-auth',\n    config: {},\n  };\n}\n\nexport function generateOpenIdConnectSecurityPlugin(\n  scheme: OA3SecuritySchemeOpenIdConnect,\n  args: Array<any>,\n): DCPlugin {\n  if (!scheme.openIdConnectUrl) {\n    throw new Error(`invalid \"openIdConnectUrl\" property. Got ${scheme.openIdConnectUrl}`);\n  }\n\n  return {\n    name: 'openid-connect',\n    config: {\n      issuer: scheme.openIdConnectUrl,\n      scopes_required: args || [],\n    },\n  };\n}\n\nexport function generateOAuth2SecurityPlugin(\n  scheme: OA3SecuritySchemeOAuth2,\n  args: ?Array<any>,\n): DCPlugin {\n  return {\n    config: {\n      auth_methods: ['client_credentials'],\n    },\n    name: 'openid-connect',\n  };\n}\n\nexport function generateSecurityPlugin(\n  scheme: OA3SecurityScheme,\n  args: Array<any>,\n): DCPlugin | null {\n  let plugin: DCPlugin | null = null;\n\n  // Generate base plugin\n  if (scheme.type === 'apiKey') {\n    plugin = generateApiKeySecurityPlugin(scheme);\n  } else if (scheme.type === 'http') {\n    plugin = generateHttpSecurityPlugin(scheme);\n  } else if (scheme.type === 'openIdConnect') {\n    plugin = generateOpenIdConnectSecurityPlugin(scheme, args);\n  } else if (scheme.type === 'oauth2') {\n    plugin = generateOAuth2SecurityPlugin(scheme);\n  } else {\n    return null;\n  }\n\n  // Add additional plugin configuration from x-kong-* properties\n  for (const key of Object.keys((scheme: Object))) {\n    if (key.indexOf('x-kong-security-') !== 0) {\n      continue;\n    }\n\n    const kongSecurity = scheme[key];\n\n    if (kongSecurity.config) {\n      plugin.config = kongSecurity.config;\n    }\n  }\n\n  return plugin;\n}\n","// @flow\n\nexport function generatePlugins(operation: OA3Operation): Array<DCPlugin> {\n  const plugins: Array<DCPlugin> = [];\n  for (const key of Object.keys(operation)) {\n    if (key.indexOf('x-kong-plugin-') !== 0) {\n      continue;\n    }\n\n    plugins.push(generatePlugin(key, operation[key], operation));\n  }\n\n  return plugins;\n}\n\nexport function generatePlugin(key: string, obj: Object, operation: OA3Operation): DCPlugin {\n  if (key.match(/-request-validator$/)) {\n    return generateRequestValidatorPlugin(obj, operation);\n  }\n\n  const plugin: DCPlugin = {\n    name: obj.name || key.replace(/^x-kong-plugin-/, ''),\n  };\n\n  if (obj.config) {\n    plugin.config = obj.config;\n  }\n\n  return plugin;\n}\n\nexport function generateRequestValidatorPlugin(obj: Object, operation: OA3Operation): DCPlugin {\n  const config: { [string]: Object } = {\n    version: 'draft4', // Fixed version\n  };\n\n  config.parameter_schema = [];\n\n  if (operation.parameters) {\n    for (const p of operation.parameters) {\n      if (!(p: Object).schema) {\n        throw new Error(\"Parameter using 'content' type validation is not supported\");\n      }\n      config.parameter_schema.push({\n        in: (p: Object).in,\n        explode: !!(p: Object).explode,\n        required: !!(p: Object).required,\n        name: (p: Object).name,\n        schema: JSON.stringify((p: Object).schema),\n        style: 'simple',\n      });\n    }\n  }\n\n  if (operation.requestBody) {\n    const content = (operation.requestBody: Object).content;\n    if (!content) {\n      throw new Error('content property is missing for request-validator!');\n    }\n\n    let bodySchema;\n    for (const item of content) {\n      if (item.mediatype !== 'application/json') {\n        throw new Error(`Body validation supports only 'application/json', not ${item.mediatype}`);\n      }\n\n      bodySchema = JSON.stringify(item.schema);\n    }\n\n    if (bodySchema) {\n      config.body_schema = bodySchema;\n    }\n  }\n\n  return {\n    config,\n    enabled: true,\n    name: 'request-validator',\n  };\n}\n","// @flow\n\nimport {\n  getName,\n  generateSlug,\n  getAllServers,\n  joinPath,\n  parseUrl,\n  pathVariablesToRegex,\n} from './common';\n\nimport { generateSecurityPlugins } from './security-plugins';\nimport { generatePlugins } from './plugins';\n\nexport function generateServices(api: OpenApi3Spec, tags: Array<string>): Array<DCService> {\n  const servers = getAllServers(api);\n\n  if (servers.length === 0) {\n    throw new Error('no servers defined in spec');\n  }\n\n  // only support one service for now\n  const service = generateService(servers[0], api, tags);\n  return [service];\n}\n\nexport function generateService(\n  server: OA3Server,\n  api: OpenApi3Spec,\n  tags: Array<string>,\n): DCService {\n  const { pathname, protocol, port } = parseUrl(server.url);\n\n  const service: DCService = {\n    name: getName(api),\n    host: getName(api),\n    path: '/',\n    port: parseInt(port),\n    protocol: protocol.replace(':', ''),\n    routes: [],\n    tags,\n  };\n\n  for (const routePath of Object.keys(api.paths)) {\n    const pathItem: OA3PathItem = api.paths[routePath];\n\n    for (const method of Object.keys(pathItem)) {\n      if (\n        method !== 'get' &&\n        method !== 'put' &&\n        method !== 'post' &&\n        method !== 'delete' &&\n        method !== 'options' &&\n        method !== 'head' &&\n        method !== 'patch' &&\n        method !== 'trace'\n      ) {\n        continue;\n      }\n\n      const operation: ?OA3Operation = pathItem[method];\n\n      // This check is here to make Flow happy\n      if (!operation) {\n        continue;\n      }\n\n      // Create the base route object\n      const fullPath = joinPath(pathname, routePath);\n      const fullPathRegex = pathVariablesToRegex(fullPath);\n      const route: DCRoute = {\n        tags,\n        name: generateRouteName(api, pathItem, method, service.routes.length),\n        methods: [method.toUpperCase()],\n        paths: [fullPathRegex],\n        strip_path: false,\n      };\n\n      // Generate generic and security-related plugin objects\n      const securityPlugins = generateSecurityPlugins(operation, api);\n      const regularPlugins = generatePlugins(operation);\n      const plugins = [...regularPlugins, ...securityPlugins];\n\n      // Add plugins if there are any\n      if (plugins.length) {\n        route.plugins = plugins;\n      }\n\n      service.routes.push(route);\n    }\n  }\n\n  return service;\n}\n\nexport function generateRouteName(\n  api: OpenApi3Spec,\n  pathItem: OA3PathItem,\n  method: string,\n  numRoutes: number,\n): string {\n  const n = numRoutes;\n  const name = getName(api);\n\n  // If a summary key exists, use that to generate the name\n  if (typeof pathItem.summary === 'string') {\n    const pathSlug = generateSlug(pathItem.summary);\n    return `${name}-${pathSlug}-${method}`;\n  }\n\n  // otherwise, use a unique integer to prevent collisions\n  return `${generateSlug(name)}-path${n ? '_' + n : ''}-${method}`;\n}\n","// @flow\n\nimport { getName, parseUrl } from './common';\n\nexport function generateUpstreams(api: OpenApi3Spec, tags: Array<string>) {\n  const servers = api.servers || [];\n\n  if (servers.length === 0) {\n    return [];\n  }\n\n  const upstream: DCUpstream = {\n    name: getName(api),\n    targets: [],\n    tags,\n  };\n\n  for (const server of servers) {\n    upstream.targets.push({\n      target: parseUrl(server.url).host,\n    });\n  }\n\n  return [upstream];\n}\n","// @flow\nimport fs from 'fs';\nimport path from 'path';\nimport { parseSpec } from './common';\nimport { generateServices } from './services';\nimport { generateUpstreams } from './upstreams';\n\nexport async function generate(specPath: string, tags: Array<string> = []): Promise<Object> {\n  return new Promise((resolve, reject) => {\n    fs.readFile(path.resolve(specPath), 'utf8', (err, contents) => {\n      if (err != null) {\n        reject(err);\n        return;\n      }\n\n      const fileSlug = path.basename(specPath);\n      const allTags = [`OAS3file_${fileSlug}`, ...tags];\n      resolve(generateFromString(contents, allTags));\n    });\n  });\n}\n\nexport async function generateFromString(\n  specStr: string,\n  tags: Array<string> = [],\n): Promise<DeclarativeConfig> {\n  const api: OpenApi3Spec = await parseSpec(specStr);\n  return generateFromSpec(api, ['OAS3_import', ...tags]);\n}\n\nexport function generateFromSpec(api: OpenApi3Spec, tags: Array<string> = []): DeclarativeConfig {\n  try {\n    return {\n      _format_version: '1.1',\n      services: generateServices(api, tags),\n      upstreams: generateUpstreams(api, tags),\n    };\n  } catch (err) {\n    throw new Error('Failed to generate spec: ' + err.message);\n  }\n}\n"]}