{"version":3,"sources":["common.js","declarative-config/security-plugins.js","declarative-config/plugins.js","declarative-config/services.js","declarative-config/upstreams.js","declarative-config/index.js","kubernetes/index.js","index.js"],"names":["getServers","obj","servers","getAllServers","api","p","Object","keys","paths","server","push","getSecurity","security","getName","defaultValue","slugifyOptions","name","info","title","generateSlug","str","options","replacement","lower","pathVariablesToRegex","result","replace","parseUrl","urlStr","parsed","url","parse","port","protocol","host","hostname","fillServerVariables","finalUrl","variables","default","Error","joinPath","p1","p2","generateSecurityPlugins","op","plugins","components","securitySchemes","securityItem","scheme","args","generateSecurityPlugin","generateApiKeySecurityPlugin","includes","in","type","config","key_names","generateHttpSecurityPlugin","toLowerCase","generateOpenIdConnectSecurityPlugin","openIdConnectUrl","issuer","scopes_required","generateOAuth2SecurityPlugin","auth_methods","plugin","key","indexOf","kongSecurity","generatePlugins","operation","generatePlugin","match","generateRequestValidatorPlugin","version","parameter_schema","parameters","schema","explode","required","JSON","stringify","style","requestBody","content","bodySchema","item","mediatype","body_schema","enabled","generateServices","tags","length","service","generateService","serverUrl","routes","routePath","pathItem","method","fullPathRegex","route","generateRouteName","methods","toUpperCase","strip_path","securityPlugins","regularPlugins","numRoutes","n","pathSlug","summary","generateUpstreams","upstream","targets","target","generateDeclarativeConfigFromSpec","_format_version","services","upstreams","err","message","document","label","warnings","generateKongForKubernetesConfigFromSpec","metadata","generateMetadata","apiVersion","kind","spec","rules","generateRules","generateMetadataName","annotations","generateMetadataAnnotations","ingressName","map","i","serviceName","generateServiceName","servicePort","generateServicePort","backend","path","generateServicePath","tlsConfig","generateTlsConfig","tls","http","index","ports","find","pathname","generate","specPath","Promise","resolve","reject","fs","readFile","contents","fileSlug","basename","allTags","generateFromString","specStr","parseSpec","generateFromSpec","SwaggerParser","YAML","openapi","dereference"],"mappings":"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","file":"index.js","sourceRoot":"../src","sourcesContent":["// @flow\nimport url from 'url';\nimport slugify from 'slugify';\n\nexport function getServers(obj: OpenApi3Spec | OA3PathItem): Array<OA3Server> {\n  return obj.servers || [];\n}\n\nexport function getAllServers(api: OpenApi3Spec): Array<OA3Server> {\n  const servers = getServers(api);\n\n  for (const p of Object.keys(api.paths)) {\n    for (const server of getServers(api.paths[p])) {\n      servers.push(server);\n    }\n  }\n\n  return servers;\n}\n\nexport function getSecurity(\n  obj: OpenApi3Spec | OA3Operation,\n): Array<OA3SecurityRequirement> | null {\n  return obj.security || [];\n}\n\nexport function getName(\n  obj: OpenApi3Spec | OA3Operation,\n  defaultValue?: string = 'openapi',\n  slugifyOptions?: {replacement: string, lower: boolean},\n): string {\n  let name;\n\n  if ((obj: any)['x-kong-name']) {\n    name = (obj: any)['x-kong-name'];\n  }\n\n  if (!name && obj.info && obj.info.title) {\n    name = obj.info.title;\n  }\n\n  return generateSlug(name || defaultValue, slugifyOptions);\n}\n\nexport function generateSlug(\n  str: string,\n  options: {replacement: string, lower: boolean} = {},\n): string {\n  options.replacement = options.replacement || '_';\n  options.lower = options.lower || false;\n  return slugify(str, options);\n}\n\nexport function pathVariablesToRegex(p: string): string {\n  const result = p.replace(/{([^}]+)}/g, '(?<$1>\\\\S+)');\n  if (result === p) {\n    return result;\n  }\n\n  // If anything was replaced, it's a regex, so add a line-ending match\n  return result + '$';\n}\n\nexport function parseUrl(\n  urlStr: string,\n): {|\n  host: string,\n  hostname: string,\n  port: string,\n  protocol: string,\n  pathname: string,\n|} {\n  const parsed: Object = url.parse(urlStr);\n\n  if (!parsed.port && parsed.protocol === 'https:') {\n    parsed.port = '443';\n  } else if (!parsed.port && parsed.protocol === 'http:') {\n    parsed.port = '80';\n  }\n\n  parsed.protocol = parsed.protocol || 'http:';\n  parsed.host = `${parsed.hostname}:${parsed.port}`;\n\n  return parsed;\n}\n\nexport function fillServerVariables(server: OA3Server): string {\n  let finalUrl = server.url;\n\n  const variables = server.variables || {};\n\n  for (const name of Object.keys(variables)) {\n    const defaultValue = variables[name].default;\n    if (!defaultValue) {\n      throw new Error(`Server variable \"${name}\" missing default value`);\n    }\n\n    finalUrl = finalUrl.replace(`{${name}}`, defaultValue);\n  }\n\n  return finalUrl;\n}\n\nexport function joinPath(p1: string, p2: string): string {\n  p1 = p1.replace(/\\/$/, '');\n  p2 = p2.replace(/^\\//, '');\n\n  return `${p1}/${p2}`;\n}\n","// @flow\n\nimport { getSecurity } from '../common';\n\nexport function generateSecurityPlugins(op: OA3Operation, api: OpenApi3Spec): Array<DCPlugin> {\n  const plugins = [];\n  const components = api.components || {};\n  const securitySchemes = components.securitySchemes || {};\n\n  const security = getSecurity(op) || getSecurity(api) || [];\n  for (const securityItem of security) {\n    for (const name of Object.keys(securityItem)) {\n      const scheme: OA3SecurityScheme = securitySchemes[name] || {};\n      const args = securityItem[name];\n\n      const p = generateSecurityPlugin(scheme, args);\n\n      if (p) {\n        plugins.push(p);\n      }\n    }\n  }\n\n  return plugins;\n}\n\nexport function generateApiKeySecurityPlugin(scheme: OA3SecuritySchemeApiKey): DCPlugin {\n  if (!['query', 'header', 'cookie'].includes(scheme.in)) {\n    throw new Error(`a ${scheme.type} object expects valid \"in\" property. Got ${scheme.in}`);\n  }\n  if (!scheme.name) {\n    throw new Error(`a ${scheme.type} object expects valid \"name\" property. Got ${scheme.name}`);\n  }\n\n  return {\n    name: 'key-auth',\n    config: { key_names: [scheme.name] },\n  };\n}\n\nexport function generateHttpSecurityPlugin(scheme: OA3SecuritySchemeHttp): DCPlugin {\n  if ((scheme.scheme || '').toLowerCase() !== 'basic') {\n    throw new Error(`Only \"basic\" http scheme supported. got ${scheme.scheme}`);\n  }\n\n  return {\n    name: 'basic-auth',\n    config: {},\n  };\n}\n\nexport function generateOpenIdConnectSecurityPlugin(\n  scheme: OA3SecuritySchemeOpenIdConnect,\n  args: Array<any>,\n): DCPlugin {\n  if (!scheme.openIdConnectUrl) {\n    throw new Error(`invalid \"openIdConnectUrl\" property. Got ${scheme.openIdConnectUrl}`);\n  }\n\n  return {\n    name: 'openid-connect',\n    config: {\n      issuer: scheme.openIdConnectUrl,\n      scopes_required: args || [],\n    },\n  };\n}\n\nexport function generateOAuth2SecurityPlugin(\n  scheme: OA3SecuritySchemeOAuth2,\n  args: ?Array<any>,\n): DCPlugin {\n  return {\n    config: {\n      auth_methods: ['client_credentials'],\n    },\n    name: 'openid-connect',\n  };\n}\n\nexport function generateSecurityPlugin(\n  scheme: OA3SecurityScheme,\n  args: Array<any>,\n): DCPlugin | null {\n  let plugin: DCPlugin | null = null;\n\n  // Flow doesn't like this (hence the \"any\" casting) but we're\n  // comparing the scheme type in a more flexible way to favor\n  // usability\n  const type = (scheme.type || '').toLowerCase();\n\n  // Generate base plugin\n  if (type === 'apikey') {\n    plugin = generateApiKeySecurityPlugin((scheme: any));\n  } else if (type === 'http') {\n    plugin = generateHttpSecurityPlugin((scheme: any));\n  } else if (type === 'openidconnect') {\n    plugin = generateOpenIdConnectSecurityPlugin((scheme: any), args);\n  } else if (type === 'oauth2') {\n    plugin = generateOAuth2SecurityPlugin((scheme: any));\n  } else {\n    return null;\n  }\n\n  // Add additional plugin configuration from x-kong-* properties\n  for (const key of Object.keys((scheme: Object))) {\n    if (key.indexOf('x-kong-security-') !== 0) {\n      continue;\n    }\n\n    const kongSecurity = scheme[key];\n\n    if (kongSecurity.config) {\n      plugin.config = kongSecurity.config;\n    }\n  }\n\n  return plugin;\n}\n","// @flow\n\nexport function generatePlugins(operation: OA3Operation): Array<DCPlugin> {\n  const plugins: Array<DCPlugin> = [];\n  for (const key of Object.keys(operation)) {\n    if (key.indexOf('x-kong-plugin-') !== 0) {\n      continue;\n    }\n\n    plugins.push(generatePlugin(key, operation[key], operation));\n  }\n\n  return plugins;\n}\n\nexport function generatePlugin(key: string, obj: Object, operation: OA3Operation): DCPlugin {\n  if (key.match(/-request-validator$/)) {\n    return generateRequestValidatorPlugin(obj, operation);\n  }\n\n  const plugin: DCPlugin = {\n    name: obj.name || key.replace(/^x-kong-plugin-/, ''),\n  };\n\n  if (obj.config) {\n    plugin.config = obj.config;\n  }\n\n  return plugin;\n}\n\nexport function generateRequestValidatorPlugin(obj: Object, operation: OA3Operation): DCPlugin {\n  const config: { [string]: Object } = {\n    version: 'draft4', // Fixed version\n  };\n\n  config.parameter_schema = [];\n\n  if (operation.parameters) {\n    for (const p of operation.parameters) {\n      if (!(p: Object).schema) {\n        throw new Error(\"Parameter using 'content' type validation is not supported\");\n      }\n      config.parameter_schema.push({\n        in: (p: Object).in,\n        explode: !!(p: Object).explode,\n        required: !!(p: Object).required,\n        name: (p: Object).name,\n        schema: JSON.stringify((p: Object).schema),\n        style: 'simple',\n      });\n    }\n  }\n\n  if (operation.requestBody) {\n    const content = (operation.requestBody: Object).content;\n    if (!content) {\n      throw new Error('content property is missing for request-validator!');\n    }\n\n    let bodySchema;\n    for (const item of content) {\n      if (item.mediatype !== 'application/json') {\n        throw new Error(`Body validation supports only 'application/json', not ${item.mediatype}`);\n      }\n\n      bodySchema = JSON.stringify(item.schema);\n    }\n\n    if (bodySchema) {\n      config.body_schema = bodySchema;\n    }\n  }\n\n  return {\n    config,\n    enabled: true,\n    name: 'request-validator',\n  };\n}\n","// @flow\n\nimport {\n  fillServerVariables,\n  generateSlug,\n  getAllServers,\n  getName,\n  pathVariablesToRegex,\n} from '../common';\n\nimport { generateSecurityPlugins } from './security-plugins';\nimport { generatePlugins } from './plugins';\n\nexport function generateServices(api: OpenApi3Spec, tags: Array<string>): Array<DCService> {\n  const servers = getAllServers(api);\n\n  if (servers.length === 0) {\n    throw new Error('no servers defined in spec');\n  }\n\n  // only support one service for now\n  const service = generateService(servers[0], api, tags);\n  return [service];\n}\n\nexport function generateService(\n  server: OA3Server,\n  api: OpenApi3Spec,\n  tags: Array<string>,\n): DCService {\n  const serverUrl = fillServerVariables(server);\n  const name = getName(api);\n  const service: DCService = {\n    name,\n    url: serverUrl,\n    routes: [],\n    tags,\n  };\n\n  for (const routePath of Object.keys(api.paths)) {\n    const pathItem: OA3PathItem = api.paths[routePath];\n\n    for (const method of Object.keys(pathItem)) {\n      if (\n        method !== 'get' &&\n        method !== 'put' &&\n        method !== 'post' &&\n        method !== 'delete' &&\n        method !== 'options' &&\n        method !== 'head' &&\n        method !== 'patch' &&\n        method !== 'trace'\n      ) {\n        continue;\n      }\n\n      const operation: ?OA3Operation = pathItem[method];\n\n      // This check is here to make Flow happy\n      if (!operation) {\n        continue;\n      }\n\n      // Create the base route object\n      const fullPathRegex = pathVariablesToRegex(routePath);\n      const route: DCRoute = {\n        tags,\n        name: generateRouteName(api, pathItem, method, service.routes.length),\n        methods: [method.toUpperCase()],\n        paths: [fullPathRegex],\n        strip_path: false,\n      };\n\n      // Generate generic and security-related plugin objects\n      const securityPlugins = generateSecurityPlugins(operation, api);\n      const regularPlugins = generatePlugins(operation);\n      const plugins = [...regularPlugins, ...securityPlugins];\n\n      // Add plugins if there are any\n      if (plugins.length) {\n        route.plugins = plugins;\n      }\n\n      service.routes.push(route);\n    }\n  }\n\n  return service;\n}\n\nexport function generateRouteName(\n  api: OpenApi3Spec,\n  pathItem: OA3PathItem,\n  method: string,\n  numRoutes: number,\n): string {\n  const n = numRoutes;\n  const name = getName(api);\n\n  if (typeof (pathItem: Object)['x-kong-name'] === 'string') {\n    const pathSlug = generateSlug((pathItem: Object)['x-kong-name']);\n    return `${name}-${pathSlug}-${method}`;\n  }\n\n  // If a summary key exists, use that to generate the name\n  if (typeof pathItem.summary === 'string') {\n    const pathSlug = generateSlug(pathItem.summary);\n    return `${name}-${pathSlug}-${method}`;\n  }\n\n  // otherwise, use a unique integer to prevent collisions\n  return `${generateSlug(name)}-path${n ? '_' + n : ''}-${method}`;\n}\n","// @flow\n\nimport { getName, parseUrl } from '../common';\n\nexport function generateUpstreams(api: OpenApi3Spec, tags: Array<string>) {\n  const servers = api.servers || [];\n\n  if (servers.length === 0) {\n    return [];\n  }\n\n  const upstream: DCUpstream = {\n    name: getName(api),\n    targets: [],\n    tags,\n  };\n\n  for (const server of servers) {\n    upstream.targets.push({\n      target: parseUrl(server.url).host,\n    });\n  }\n\n  return [upstream];\n}\n","// @flow\nimport { generateServices } from './services';\nimport { generateUpstreams } from './upstreams';\n\nexport function generateDeclarativeConfigFromSpec(\n  api: OpenApi3Spec,\n  tags: Array<string>,\n): DeclarativeConfigResult {\n  let result = null;\n  try {\n    result = {\n      _format_version: '1.1',\n      services: generateServices(api, tags),\n      upstreams: generateUpstreams(api, tags),\n    };\n  } catch (err) {\n    throw new Error('Failed to generate spec: ' + err.message);\n  }\n\n  // This remover any circular references or weirdness that might result\n  // from the JS objects used.\n  // SEE: https://github.com/Kong/studio/issues/93\n  const document = JSON.parse(JSON.stringify(result));\n\n  return {\n    type: 'kong-declarative-config',\n    label: 'Kong Declarative Config',\n    document,\n    warnings: [],\n  };\n}\n","// @flow\n\nimport { getName, getServers, parseUrl } from '../common';\n\nexport function generateKongForKubernetesConfigFromSpec(\n  api: OpenApi3Spec,\n  tags: Array<string>,\n): KongForKubernetesResult {\n  const metadata = generateMetadata(api);\n  const document: KubernetesConfig = {\n    apiVersion: 'extensions/v1beta1',\n    kind: 'Ingress',\n    metadata,\n    spec: { rules: generateRules(api, metadata.name) },\n  };\n\n  return ({\n    type: 'kong-for-kubernetes',\n    label: 'Kong for Kubernetes',\n    document,\n    warnings: [],\n  }: KongForKubernetesResult);\n}\n\nfunction generateMetadata(api: OpenApi3Spec): K8sMetadata {\n  const metadata: K8sMetadata = {\n    name: generateMetadataName(api),\n  };\n\n  const annotations = generateMetadataAnnotations(api);\n  if (annotations) {\n    metadata.annotations = annotations;\n  }\n\n  return metadata;\n}\n\nexport function generateMetadataName(api: OpenApi3Spec): string {\n  const info: Object = api.info || {};\n  const metadata = info['x-kubernetes-ingress-metadata'];\n\n  // x-kubernetes-ingress-metadata.name\n  if (metadata && metadata.name) {\n    return metadata.name;\n  }\n\n  return getName(api, 'openapi', { lower: true, replacement: '-' });\n}\n\nexport function generateMetadataAnnotations(api: OpenApi3Spec): K8sAnnotations | null {\n  const info: Object = api.info || {};\n  const metadata = info['x-kubernetes-ingress-metadata'];\n  if (metadata && metadata.annotations) {\n    return metadata.annotations;\n  }\n\n  return null;\n}\n\nexport function generateRules(api: OpenApi3Spec, ingressName: string): K8sIngressRules {\n  return getServers(api).map((server, i) => {\n    const { hostname } = parseUrl(server.url);\n    const serviceName = generateServiceName(server, ingressName, i);\n    const servicePort = generateServicePort(server);\n    const backend = { serviceName, servicePort };\n    const path = generateServicePath(server, backend);\n\n    const tlsConfig = generateTlsConfig(server);\n    if (tlsConfig) {\n      return {\n        host: hostname,\n        tls: {\n          paths: [path],\n          ...tlsConfig,\n        },\n      };\n    }\n\n    return {\n      host: hostname,\n      http: { paths: [path] },\n    };\n  });\n}\n\nexport function generateServiceName(server: OA3Server, ingressName: string, index: number): string {\n  const backend = (server: Object)['x-kubernetes-backend'];\n\n  // x-kubernetes-backend.serviceName\n  if (backend && backend['serviceName']) {\n    return backend['serviceName'];\n  }\n\n  // x-kubernetes-service.metadata.name\n  const service = (server: Object)['x-kubernetes-service'];\n  if (service && service.metadata && service.metadata.name) {\n    return service.metadata.name;\n  }\n\n  // <ingress-name>-s<server index>\n  return `${ingressName}-s${index}`;\n}\n\nexport function generateTlsConfig(server: OA3Server): Object | null {\n  const tlsConfig = (server: Object)['x-kubernetes-tls'];\n  return tlsConfig || null;\n}\n\nexport function generateServicePort(server: OA3Server): number {\n  // x-kubernetes-backend.servicePort\n  const backend = (server: Object)['x-kubernetes-backend'];\n  if (backend && typeof backend.servicePort === 'number') {\n    return backend.servicePort;\n  }\n\n  const service = (server: Object)['x-kubernetes-service'] || {};\n  const spec = service.spec || {};\n  const ports = spec.ports || [];\n\n  // TLS configured\n  const tlsConfig = generateTlsConfig(server);\n  if (tlsConfig) {\n    if (ports.find(p => p.port === 443)) {\n      return 443;\n    }\n\n    if (ports[0] && ports[0].port) {\n      return ports[0].port;\n    }\n\n    return 443;\n  }\n\n  // x-kubernetes-service.spec.ports.0.port\n  if (ports[0] && ports[0].port) {\n    return ports[0].port;\n  }\n\n  return 80;\n}\n\nexport function generateServicePath(server: OA3Server, backend: K8sBackend): K8sPath {\n  const { pathname } = parseUrl(server.url);\n  const p: K8sPath = {\n    backend,\n  };\n\n  if (!pathname || pathname === '/') {\n    return p;\n  }\n\n  if (pathname.match(/\\/$/)) {\n    p.path = pathname + '.*';\n  } else {\n    p.path = pathname + '/.*';\n  }\n\n  return p;\n}\n","// @flow\nimport fs from 'fs';\nimport path from 'path';\nimport { generateDeclarativeConfigFromSpec } from './declarative-config';\nimport { generateKongForKubernetesConfigFromSpec } from './kubernetes';\nimport SwaggerParser from 'swagger-parser';\n\nexport async function generate(\n  specPath: string,\n  type: ConversionResultType,\n  tags: Array<string> = [],\n): Promise<ConversionResult> {\n  return new Promise((resolve, reject) => {\n    fs.readFile(path.resolve(specPath), 'utf8', (err, contents) => {\n      if (err != null) {\n        reject(err);\n        return;\n      }\n\n      const fileSlug = path.basename(specPath);\n      const allTags = [`OAS3file_${fileSlug}`, ...tags];\n      resolve(generateFromString(contents, type, allTags));\n    });\n  });\n}\n\nexport async function generateFromString(\n  specStr: string,\n  type: ConversionResultType,\n  tags: Array<string> = [],\n): Promise<ConversionResult> {\n  const api: OpenApi3Spec = await parseSpec(specStr);\n  return generateFromSpec(api, type, ['OAS3_import', ...tags]);\n}\n\nexport function generateFromSpec(\n  api: OpenApi3Spec,\n  type: ConversionResultType,\n  tags: Array<string> = [],\n): ConversionResult {\n  switch (type) {\n    case 'kong-declarative-config':\n      return generateDeclarativeConfigFromSpec(api, tags);\n    case 'kong-for-kubernetes':\n      return generateKongForKubernetesConfigFromSpec(api, tags);\n    default:\n      throw new Error(`Unsupported output type \"${type}\"`);\n  }\n}\n\nexport async function parseSpec(spec: string | Object): Promise<OpenApi3Spec> {\n  let api: OpenApi3Spec;\n\n  if (typeof spec === 'string') {\n    try {\n      api = JSON.parse(spec);\n    } catch (err) {\n      api = SwaggerParser.YAML.parse(spec);\n    }\n  } else {\n    api = JSON.parse(JSON.stringify(spec));\n  }\n\n  // Ensure it has some required properties to make parsing\n  // a bit less strict\n\n  if (!api.info) {\n    api.info = {};\n  }\n\n  if (api.openapi === '3.0') {\n    api.openapi = '3.0.0';\n  }\n\n  return SwaggerParser.dereference(api);\n}\n"]}