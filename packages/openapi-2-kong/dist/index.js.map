{"version":3,"sources":["common.js","security-plugins.js","plugins.js","services.js","upstreams.js","index.js"],"names":["parseSpec","spec","api","JSON","parse","err","SwaggerParser","YAML","stringify","info","openapi","dereference","getServers","obj","servers","getAllServers","p","Object","keys","paths","server","push","getSecurity","security","getName","name","title","generateSlug","str","replace","pathVariablesToRegex","result","parseUrl","urlStr","parsed","url","port","protocol","host","hostname","fillServerVariables","finalUrl","variables","defaultValue","default","Error","joinPath","p1","p2","generateSecurityPlugins","op","plugins","components","securitySchemes","securityItem","scheme","args","generateSecurityPlugin","generateApiKeySecurityPlugin","includes","in","type","config","key_names","generateHttpSecurityPlugin","generateOpenIdConnectSecurityPlugin","openIdConnectUrl","issuer","scopes_required","generateOAuth2SecurityPlugin","auth_methods","plugin","key","indexOf","kongSecurity","generatePlugins","operation","generatePlugin","match","generateRequestValidatorPlugin","version","parameter_schema","parameters","schema","explode","required","style","requestBody","content","bodySchema","item","mediatype","body_schema","enabled","generateServices","tags","length","service","generateService","serverUrl","routes","routePath","pathItem","method","fullPathRegex","route","generateRouteName","methods","toUpperCase","strip_path","securityPlugins","regularPlugins","numRoutes","n","pathSlug","summary","generateUpstreams","upstream","targets","target","generate","specPath","Promise","resolve","reject","fs","readFile","path","contents","fileSlug","basename","allTags","generateFromString","specStr","generateFromSpec","_format_version","services","upstreams","message"],"mappings":"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","file":"index.js","sourceRoot":"../src","sourcesContent":["// @flow\nimport SwaggerParser from 'swagger-parser';\nimport url from 'url';\n\nexport async function parseSpec(spec: string | Object): Promise<OpenApi3Spec> {\n  let api: OpenApi3Spec;\n\n  if (typeof spec === 'string') {\n    try {\n      api = JSON.parse(spec);\n    } catch (err) {\n      api = SwaggerParser.YAML.parse(spec);\n    }\n  } else {\n    api = JSON.parse(JSON.stringify(spec));\n  }\n\n  // Ensure it has some required properties to make parsing\n  // a bit less strict\n\n  if (!api.info) {\n    api.info = {};\n  }\n\n  if (api.openapi === '3.0') {\n    api.openapi = '3.0.0';\n  }\n\n  return SwaggerParser.dereference(api);\n}\n\nexport function getServers(obj: OpenApi3Spec | OA3PathItem): Array<OA3Server> {\n  return obj.servers || [];\n}\n\nexport function getAllServers(api: OpenApi3Spec): Array<OA3Server> {\n  const servers = getServers(api);\n\n  for (const p of Object.keys(api.paths)) {\n    for (const server of getServers(api.paths[p])) {\n      servers.push(server);\n    }\n  }\n\n  return servers;\n}\n\nexport function getSecurity(\n  obj: OpenApi3Spec | OA3Operation,\n): Array<OA3SecurityRequirement> | null {\n  return obj.security || [];\n}\n\nexport function getName(obj: OpenApi3Spec | OA3Operation): string {\n  let name;\n\n  if ((obj: any)['x-kong-name']) {\n    name = (obj: any)['x-kong-name'];\n  }\n\n  if (!name && obj.info && obj.info.title) {\n    name = obj.info.title;\n  }\n\n  return generateSlug(name || 'openapi');\n}\n\nexport function generateSlug(str: string): string {\n  return str.replace(/[\\s_\\-.~,]/g, '_');\n}\n\nexport function pathVariablesToRegex(p: string): string {\n  const result = p.replace(/{([^}]+)}/g, '(?<$1>\\\\S+)');\n  if (result === p) {\n    return result;\n  }\n\n  // If anything was replaced, it's a regex, so add a line-ending match\n  return result + '$';\n}\n\nexport function parseUrl(\n  urlStr: string,\n): {|\n  host: string,\n  hostname: string,\n  port: string,\n  protocol: string,\n  pathname: string,\n|} {\n  const parsed: Object = url.parse(urlStr);\n\n  if (!parsed.port && parsed.protocol === 'https:') {\n    parsed.port = '443';\n  } else if (!parsed.port && parsed.protocol === 'http:') {\n    parsed.port = '80';\n  }\n\n  parsed.protocol = parsed.protocol || 'http:';\n  parsed.host = `${parsed.hostname}:${parsed.port}`;\n\n  return parsed;\n}\n\nexport function fillServerVariables(server: OA3Server): string {\n  let finalUrl = server.url;\n\n  const variables = server.variables || {};\n\n  for (const name of Object.keys(variables)) {\n    const defaultValue = variables[name].default;\n    if (!defaultValue) {\n      throw new Error(`Server variable \"${name}\" missing default value`);\n    }\n\n    finalUrl = finalUrl.replace(`{${name}}`, defaultValue);\n  }\n\n  return finalUrl;\n}\n\nexport function joinPath(p1: string, p2: string): string {\n  p1 = p1.replace(/\\/$/, '');\n  p2 = p2.replace(/^\\//, '');\n\n  return `${p1}/${p2}`;\n}\n","// @flow\n\nimport { getSecurity } from './common';\n\nexport function generateSecurityPlugins(op: OA3Operation, api: OpenApi3Spec): Array<DCPlugin> {\n  const plugins = [];\n  const components = api.components || {};\n  const securitySchemes = components.securitySchemes || {};\n\n  const security = getSecurity(op) || getSecurity(api) || [];\n  for (const securityItem of security) {\n    for (const name of Object.keys(securityItem)) {\n      const scheme: OA3SecurityScheme = securitySchemes[name] || {};\n      const args = securityItem[name];\n\n      const p = generateSecurityPlugin(scheme, args);\n\n      if (p) {\n        plugins.push(p);\n      }\n    }\n  }\n\n  return plugins;\n}\n\nexport function generateApiKeySecurityPlugin(scheme: OA3SecuritySchemeApiKey): DCPlugin {\n  if (!['query', 'header', 'cookie'].includes(scheme.in)) {\n    throw new Error(`a ${scheme.type} object expects valid \"in\" property. Got ${scheme.in}`);\n  }\n  if (!scheme.name) {\n    throw new Error(`a ${scheme.type} object expects valid \"name\" property. Got ${scheme.name}`);\n  }\n\n  return {\n    name: 'key-auth',\n    config: { key_names: [scheme.name] },\n  };\n}\n\nexport function generateHttpSecurityPlugin(scheme: OA3SecuritySchemeHttp): DCPlugin {\n  if (scheme.scheme !== 'basic') {\n    throw new Error(`Only \"basic\" http scheme supported. got ${scheme.scheme}`);\n  }\n\n  return {\n    name: 'basic-auth',\n    config: {},\n  };\n}\n\nexport function generateOpenIdConnectSecurityPlugin(\n  scheme: OA3SecuritySchemeOpenIdConnect,\n  args: Array<any>,\n): DCPlugin {\n  if (!scheme.openIdConnectUrl) {\n    throw new Error(`invalid \"openIdConnectUrl\" property. Got ${scheme.openIdConnectUrl}`);\n  }\n\n  return {\n    name: 'openid-connect',\n    config: {\n      issuer: scheme.openIdConnectUrl,\n      scopes_required: args || [],\n    },\n  };\n}\n\nexport function generateOAuth2SecurityPlugin(\n  scheme: OA3SecuritySchemeOAuth2,\n  args: ?Array<any>,\n): DCPlugin {\n  return {\n    config: {\n      auth_methods: ['client_credentials'],\n    },\n    name: 'openid-connect',\n  };\n}\n\nexport function generateSecurityPlugin(\n  scheme: OA3SecurityScheme,\n  args: Array<any>,\n): DCPlugin | null {\n  let plugin: DCPlugin | null = null;\n\n  // Generate base plugin\n  if (scheme.type === 'apiKey') {\n    plugin = generateApiKeySecurityPlugin(scheme);\n  } else if (scheme.type === 'http') {\n    plugin = generateHttpSecurityPlugin(scheme);\n  } else if (scheme.type === 'openIdConnect') {\n    plugin = generateOpenIdConnectSecurityPlugin(scheme, args);\n  } else if (scheme.type === 'oauth2') {\n    plugin = generateOAuth2SecurityPlugin(scheme);\n  } else {\n    return null;\n  }\n\n  // Add additional plugin configuration from x-kong-* properties\n  for (const key of Object.keys((scheme: Object))) {\n    if (key.indexOf('x-kong-security-') !== 0) {\n      continue;\n    }\n\n    const kongSecurity = scheme[key];\n\n    if (kongSecurity.config) {\n      plugin.config = kongSecurity.config;\n    }\n  }\n\n  return plugin;\n}\n","// @flow\n\nexport function generatePlugins(operation: OA3Operation): Array<DCPlugin> {\n  const plugins: Array<DCPlugin> = [];\n  for (const key of Object.keys(operation)) {\n    if (key.indexOf('x-kong-plugin-') !== 0) {\n      continue;\n    }\n\n    plugins.push(generatePlugin(key, operation[key], operation));\n  }\n\n  return plugins;\n}\n\nexport function generatePlugin(key: string, obj: Object, operation: OA3Operation): DCPlugin {\n  if (key.match(/-request-validator$/)) {\n    return generateRequestValidatorPlugin(obj, operation);\n  }\n\n  const plugin: DCPlugin = {\n    name: obj.name || key.replace(/^x-kong-plugin-/, ''),\n  };\n\n  if (obj.config) {\n    plugin.config = obj.config;\n  }\n\n  return plugin;\n}\n\nexport function generateRequestValidatorPlugin(obj: Object, operation: OA3Operation): DCPlugin {\n  const config: { [string]: Object } = {\n    version: 'draft4', // Fixed version\n  };\n\n  config.parameter_schema = [];\n\n  if (operation.parameters) {\n    for (const p of operation.parameters) {\n      if (!(p: Object).schema) {\n        throw new Error(\"Parameter using 'content' type validation is not supported\");\n      }\n      config.parameter_schema.push({\n        in: (p: Object).in,\n        explode: !!(p: Object).explode,\n        required: !!(p: Object).required,\n        name: (p: Object).name,\n        schema: JSON.stringify((p: Object).schema),\n        style: 'simple',\n      });\n    }\n  }\n\n  if (operation.requestBody) {\n    const content = (operation.requestBody: Object).content;\n    if (!content) {\n      throw new Error('content property is missing for request-validator!');\n    }\n\n    let bodySchema;\n    for (const item of content) {\n      if (item.mediatype !== 'application/json') {\n        throw new Error(`Body validation supports only 'application/json', not ${item.mediatype}`);\n      }\n\n      bodySchema = JSON.stringify(item.schema);\n    }\n\n    if (bodySchema) {\n      config.body_schema = bodySchema;\n    }\n  }\n\n  return {\n    config,\n    enabled: true,\n    name: 'request-validator',\n  };\n}\n","// @flow\n\nimport {\n  fillServerVariables,\n  generateSlug,\n  getAllServers,\n  getName,\n  pathVariablesToRegex,\n} from './common';\n\nimport { generateSecurityPlugins } from './security-plugins';\nimport { generatePlugins } from './plugins';\n\nexport function generateServices(api: OpenApi3Spec, tags: Array<string>): Array<DCService> {\n  const servers = getAllServers(api);\n\n  if (servers.length === 0) {\n    throw new Error('no servers defined in spec');\n  }\n\n  // only support one service for now\n  const service = generateService(servers[0], api, tags);\n  return [service];\n}\n\nexport function generateService(\n  server: OA3Server,\n  api: OpenApi3Spec,\n  tags: Array<string>,\n): DCService {\n  const serverUrl = fillServerVariables(server);\n  const name = getName(api);\n  const service: DCService = {\n    name,\n    url: serverUrl,\n    routes: [],\n    tags,\n  };\n\n  for (const routePath of Object.keys(api.paths)) {\n    const pathItem: OA3PathItem = api.paths[routePath];\n\n    for (const method of Object.keys(pathItem)) {\n      if (\n        method !== 'get' &&\n        method !== 'put' &&\n        method !== 'post' &&\n        method !== 'delete' &&\n        method !== 'options' &&\n        method !== 'head' &&\n        method !== 'patch' &&\n        method !== 'trace'\n      ) {\n        continue;\n      }\n\n      const operation: ?OA3Operation = pathItem[method];\n\n      // This check is here to make Flow happy\n      if (!operation) {\n        continue;\n      }\n\n      // Create the base route object\n      const fullPathRegex = pathVariablesToRegex(routePath);\n      const route: DCRoute = {\n        tags,\n        name: generateRouteName(api, pathItem, method, service.routes.length),\n        methods: [method.toUpperCase()],\n        paths: [fullPathRegex],\n        strip_path: false,\n      };\n\n      // Generate generic and security-related plugin objects\n      const securityPlugins = generateSecurityPlugins(operation, api);\n      const regularPlugins = generatePlugins(operation);\n      const plugins = [...regularPlugins, ...securityPlugins];\n\n      // Add plugins if there are any\n      if (plugins.length) {\n        route.plugins = plugins;\n      }\n\n      service.routes.push(route);\n    }\n  }\n\n  return service;\n}\n\nexport function generateRouteName(\n  api: OpenApi3Spec,\n  pathItem: OA3PathItem,\n  method: string,\n  numRoutes: number,\n): string {\n  const n = numRoutes;\n  const name = getName(api);\n\n  if (typeof (pathItem: Object)['x-kong-name'] === 'string') {\n    const pathSlug = generateSlug((pathItem: Object)['x-kong-name']);\n    return `${name}-${pathSlug}-${method}`;\n  }\n\n  // If a summary key exists, use that to generate the name\n  if (typeof pathItem.summary === 'string') {\n    const pathSlug = generateSlug(pathItem.summary);\n    return `${name}-${pathSlug}-${method}`;\n  }\n\n  // otherwise, use a unique integer to prevent collisions\n  return `${generateSlug(name)}-path${n ? '_' + n : ''}-${method}`;\n}\n","// @flow\n\nimport { getName, parseUrl } from './common';\n\nexport function generateUpstreams(api: OpenApi3Spec, tags: Array<string>) {\n  const servers = api.servers || [];\n\n  if (servers.length === 0) {\n    return [];\n  }\n\n  const upstream: DCUpstream = {\n    name: getName(api),\n    targets: [],\n    tags,\n  };\n\n  for (const server of servers) {\n    upstream.targets.push({\n      target: parseUrl(server.url).host,\n    });\n  }\n\n  return [upstream];\n}\n","// @flow\nimport fs from 'fs';\nimport path from 'path';\nimport { parseSpec } from './common';\nimport { generateServices } from './services';\nimport { generateUpstreams } from './upstreams';\n\nexport async function generate(specPath: string, tags: Array<string> = []): Promise<Object> {\n  return new Promise((resolve, reject) => {\n    fs.readFile(path.resolve(specPath), 'utf8', (err, contents) => {\n      if (err != null) {\n        reject(err);\n        return;\n      }\n\n      const fileSlug = path.basename(specPath);\n      const allTags = [`OAS3file_${fileSlug}`, ...tags];\n      resolve(generateFromString(contents, allTags));\n    });\n  });\n}\n\nexport async function generateFromString(\n  specStr: string,\n  tags: Array<string> = [],\n): Promise<DeclarativeConfig> {\n  const api: OpenApi3Spec = await parseSpec(specStr);\n  return generateFromSpec(api, ['OAS3_import', ...tags]);\n}\n\nexport function generateFromSpec(\n  api: OpenApi3Spec,\n  tags: Array<string> = [],\n): DeclarativeConfig {\n  let result = null;\n  try {\n     result = {\n      _format_version: '1.1',\n      services: generateServices(api, tags),\n      upstreams: generateUpstreams(api, tags),\n    };\n  } catch (err) {\n    throw new Error('Failed to generate spec: ' + err.message);\n  }\n\n  // This remover any circular references or weirdness that might result\n  // from the JS objects used.\n  // SEE: https://github.com/Kong/studio/issues/93\n  return JSON.parse(JSON.stringify(result));\n}\n"]}